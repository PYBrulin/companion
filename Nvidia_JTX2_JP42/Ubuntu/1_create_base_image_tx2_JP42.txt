# TX2 setup script for use as companion computer with Jetpack 4.2 release

# STEP1: install NVidia image onto JTX2 (skip this step if you already have a factory image (created in Step2) for the current release of JetPack.  This is required as the flashing of the APsync image only updates one partition - the other partitions on the device must match the one we are putting onto the device.

# Download the SDKManager to your host machine and follow all the instructions here: 
# https://developer.nvidia.com/embedded/jetpack

# STEP2: backup the TX2 kernel before installing APSync so that you can roll back in case something breaks or messes up

# Follow the steps as explained here: https://elinux.org/Jetson/TX2_Cloning
# The TX2 must be connected to the host machine over USB and entered into recovery mode. Then enter on the host machine:

cd home/nvidia/nvidia_sdk/JetPack_4.2_Linux_P3310/Linux_for_Tegra
sudo ./flash.sh -r -k APP -G mybackup_Jetpack42.img jetson-tx2 mmcblk0p1
# for "mybackup_Jetpack42" add your desired name for the backup image file. This will take about 30 minutes.


# STEP 3 : install apsync packages on the TX2:
# power on the TX
# log onto TX with your credentials as created during the installation of Jetpack 4.2.
# create an apsync user:

sudo useradd -s /bin/bash -m -U -G sudo,netdev,users,dialout,video apsync
sudo passwd apsync # apsync

# logon as apsync
su apsync
cd ~

# clone the Apsync git
mkdir GitHub
pushd GitHub

# insert here the link to the master repository
# git clone https://github.com/ArduPilot/companion.git
git clone --single-branch --branch "next-tx2" https://github.com/mtbsteve/companion.git

pushd companion/Nvidia_JTX2_JP42/Ubuntu
sudo ./set-hostname   # reset the machine's hostname
# if your hostname is not tegra-ubuntu, then execute the following statement instead:
sudo perl -pe s/<enter your hostname here>/apsync/ -i /etc/hosts

sudo apt-get autoremove -y # avoid repeated no-longer-required annoyance
sudo ./change-autologin-user_1804.sh # we go for a timed login instead. After 5 seconds, the TX2 will automatically boot under apsync user.
sudo ./remove-unattended-upgrades # 
sudo ./ensure_rc_local.sh

sudo reboot # ensure hostname correct / autologin working
ssh apsync@apsync

pushd GitHub/companion/Nvidia_JTX2_JP42/Ubuntu
time sudo -E ./2_install_packages.sh # 20m
time sudo -E ./install_niceties || echo "Failed" # 20s

# setup of the ardupilot access point
sudo ./3_wifi_access_point_JP42.sh
# the TX2 will go into AP mode when you logon under apsync and will set up an access point with the SSID ardupilot.
# You can swap between AP mode and wifi client mode by executing from the apsync home directory:
# sudo ~/switch_AP_client_mode.sh

sudo ./4_setup_log_rotation # instant
# we will install mavproxy, however cmavnode will be used 
sudo ./5_setup_mavproxy.sh # instant

time sudo -E ./6_setup_video.sh # 1m
time sudo -E ./8_setup_cmavnode.sh # ~4m
time sudo -E ./setup_mavlink-router # ~2m
time sudo -E ./7_dflogger.sh # ~210s
time sudo -E ./setup-video-streaming # 11s

time sudo -E apt-get install -y libxml2-dev libxslt1.1 libxslt1-dev
time sudo pip install future lxml # 4m
time sudo ./install_pymavlink # new version required for apweb #1m
time sudo ./install_apweb # 2m

# OpenKAI not available due to OpenCV compatability issues....
# time sudo -E ./install_openkai.sh

# reboot and test image according to testing.txt
sudo reboot

# Step 4: cleanup
time (pushd ~/GitHub/companion/Nvidia_JTX1/Ubuntu && sudo ./clean-for-imaging)


sudo poweroff

# Step 5: download apsync image from TX2:
#    put TX2 into bootloader mode: Hold Force Recovery button (aka "REC"), press Reset button(aka "RST"), Release Force Recovery button
watch lsusb
BASEDIR=~/jetpack
L4T=$BASEDIR/64_TX2/Linux_for_Tegra
#    run download_image.sh from this repo:
TIMESTAMP=`date '+%Y%m%d%H%M'`
# consider using an absolute path for IMAGE_NAME here! e.g. /vagrant/...
IMAGE_NAME="/vagrant/apsync-tx2-$TIMESTAMP.img"

cd $L4T
time sudo ./flash.sh -r -k APP -G $IMAGE_NAME jetson-tx2 mmcblk0p1 # about 30 minutes

# on host machine (not on the Vagrant VM!)
ls -l $IMAGE_NAME # about 8GB
time xz --verbose -e $IMAGE_NAME # about 1.5 hours
COMPRESSED_IMAGE_NAME="$IMAGE_NAME.xz"
ls -l --si  $COMPRESSED_IMAGE_NAME # ~3.2GB
BASE_COMPRESSED_IMAGE_NAME=$(basename "$COMPRESSED_IMAGE_NAME")
time rsync -aP $COMPRESSED_IMAGE_NAME autotest@autotest.ardupilot.org:APM/buildlogs/binaries/Companion/next/$BASE_COMPRESSED_IMAGE_NAME # about 11.5 hours
